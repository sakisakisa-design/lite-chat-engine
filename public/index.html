<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lite Chat Engine - æ§åˆ¶é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #fff5f5;
            --bg-secondary: #ffe4e6;
            --bg-card: #fecdd3;
            --text-primary: #4a4a4a;
            --text-secondary: #9ca3af;
            --accent: #f472b6;
            --accent-hover: #ec4899;
            --success: #86efac;
            --warning: #fcd34d;
            --error: #fca5a5;
            --border: #fda4af;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 1.8rem;
            color: var(--accent);
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--error);
        }

        .status-dot.connected {
            background: var(--success);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab:hover {
            background: var(--bg-card);
        }

        .tab.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .panel {
            display: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border);
        }

        .panel.active {
            display: block;
        }

        .panel h2 {
            margin-bottom: 20px;
            color: var(--accent);
            font-size: 1.4rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .card h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 10px 20px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.3s;
        }

        button:hover {
            background: var(--accent-hover);
        }

        button.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background: var(--border);
        }

        button.success {
            background: var(--success);
        }

        button.danger {
            background: var(--error);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .list {
            max-height: 300px;
            overflow-y: auto;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-primary);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .list-item:hover {
            background: var(--border);
        }

        .list-item.selected {
            border-left: 3px solid var(--accent);
        }

        .list-item .name {
            font-weight: 500;
        }

        .list-item .meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .log-container {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid var(--border);
        }

        .log-entry.info { color: var(--text-primary); }
        .log-entry.warn { color: var(--warning); }
        .log-entry.error { color: var(--error); }
        .log-entry.debug { color: var(--text-secondary); }

        .log-time {
            color: var(--text-secondary);
            margin-right: 10px;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .session-info {
            flex: 1;
        }

        .session-id {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .session-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .message-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .message.user {
            background: var(--bg-card);
            margin-left: 20%;
        }

        .message.assistant {
            background: var(--bg-primary);
            margin-right: 20%;
        }

        .message-role {
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .regex-rule {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .regex-rule .pattern {
            font-family: monospace;
            background: var(--bg-card);
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--bg-card);
            border-radius: 8px;
            border-left: 4px solid var(--success);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        .toast.error {
            border-left-color: var(--error);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--accent);
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
        }

        .badge.success { background: var(--success); }
        .badge.warning { background: var(--warning); color: #000; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤– Lite Chat Engine</h1>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="onebot-status"></span>
                    <span>OneBot</span>
                </div>
                <div class="status-item">
                    <span id="current-character">æœªé€‰æ‹©è§’è‰²</span>
                </div>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" data-panel="dashboard">ğŸ“Š ä»ªè¡¨ç›˜</div>
            <div class="tab" data-panel="characters">ğŸ‘¤ è§’è‰²å¡</div>
            <div class="tab" data-panel="worldbooks">ğŸ“š ä¸–ç•Œä¹¦</div>
            <div class="tab" data-panel="sessions">ğŸ’¬ ä¼šè¯</div>
            <div class="tab" data-panel="regex">ğŸ”§ æ­£åˆ™è§„åˆ™</div>
            <div class="tab" data-panel="config">âš™ï¸ é…ç½®</div>
            <div class="tab" data-panel="logs">ğŸ“ æ—¥å¿—</div>
        </div>

        <!-- ä»ªè¡¨ç›˜ -->
        <div class="panel active" id="dashboard">
            <h2>ç³»ç»ŸçŠ¶æ€</h2>
            <div class="grid">
                <div class="card">
                    <h3>è¿æ¥çŠ¶æ€</h3>
                    <div class="status-item" style="margin-bottom: 10px;">
                        <span class="status-dot" id="onebot-status-2"></span>
                        <span>OneBot è¿æ¥</span>
                    </div>
                    <button onclick="reconnectOneBot()">é‡æ–°è¿æ¥</button>
                </div>
                <div class="card">
                    <h3>å½“å‰é…ç½®</h3>
                    <p style="margin-bottom: 8px;">è§’è‰²: <strong id="dash-character">-</strong></p>
                    <p style="margin-bottom: 8px;">ä¸–ç•Œä¹¦: <strong id="dash-worldbook">-</strong></p>
                    <p>æ´»è·ƒä¼šè¯: <strong id="dash-sessions">0</strong></p>
                </div>
                <div class="card">
                    <h3>å¿«é€Ÿæµ‹è¯•</h3>
                    <div class="form-group">
                        <input type="text" id="test-message" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯...">
                    </div>
                    <button onclick="testAI()">æµ‹è¯• AI</button>
                    <div id="test-result" style="margin-top: 15px; padding: 10px; background: var(--bg-primary); border-radius: 6px; display: none;"></div>
                </div>
            </div>
        </div>

        <!-- è§’è‰²å¡ -->
        <div class="panel" id="characters">
            <h2>è§’è‰²å¡ç®¡ç†</h2>
            <div class="btn-group" style="margin-bottom: 20px;">
                <button onclick="refreshCharacters()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                <label class="upload-btn" style="padding: 10px 20px; background: #1a1a1a; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.95rem;">
                    ğŸ“¤ ä¸Šä¼ è§’è‰²å¡ (PNG)
                    <input type="file" accept=".png" onchange="uploadCharacter(this)" style="display: none;">
                </label>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                ğŸ’¡ æ”¯æŒ SillyTavern æ ¼å¼çš„è§’è‰²å¡ PNG æ–‡ä»¶ï¼ˆåŒ…å« tEXt/iTXt å—çš„è§’è‰²æ•°æ®ï¼‰
            </p>
            <div class="grid">
                <div class="card" style="max-width: 350px;">
                    <h3>è§’è‰²åˆ—è¡¨</h3>
                    <div class="list" id="character-list">
                        <div class="empty-state">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <div class="card" style="flex: 1; min-width: 500px;">
                    <h3>è§’è‰²è¯¦æƒ… <span id="char-edit-status" style="font-size: 0.8rem; color: var(--text-secondary);"></span></h3>
                    <div id="character-detail">
                        <div class="empty-state">é€‰æ‹©ä¸€ä¸ªè§’è‰²æŸ¥çœ‹è¯¦æƒ…</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸–ç•Œä¹¦ -->
        <div class="panel" id="worldbooks">
            <h2>ä¸–ç•Œä¹¦ç®¡ç†</h2>
            <div class="btn-group" style="margin-bottom: 20px;">
                <button onclick="refreshWorldBooks()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                <label class="upload-btn" style="padding: 10px 20px; background: #1a1a1a; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.95rem;">
                    ğŸ“¤ ä¸Šä¼ ä¸–ç•Œä¹¦ (JSON)
                    <input type="file" accept=".json" onchange="uploadWorldBook(this)" style="display: none;">
                </label>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                ğŸ’¡ æ”¯æŒ SillyTavern æ ¼å¼çš„ä¸–ç•Œä¹¦ JSON æ–‡ä»¶ï¼ˆWorldInfo æ ¼å¼ï¼‰
            </p>
            <div class="grid">
                <div class="card">
                    <h3>ä¸–ç•Œä¹¦åˆ—è¡¨</h3>
                    <div class="list" id="worldbook-list">
                        <div class="empty-state">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <div class="card" style="flex: 1; min-width: 500px;">
                    <h3>ä¸–ç•Œä¹¦æ¡ç›®ç¼–è¾‘å™¨</h3>
                    <div id="worldbook-editor">
                        <div class="empty-state">é€‰æ‹©ä¸€ä¸ªä¸–ç•Œä¹¦æŸ¥çœ‹å’Œç¼–è¾‘æ¡ç›®</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¼šè¯ -->
        <div class="panel" id="sessions">
            <h2>ä¼šè¯ç®¡ç†</h2>
            <div class="grid">
                <div class="card">
                    <h3>æ´»è·ƒä¼šè¯</h3>
                    <div id="session-list">
                        <div class="empty-state">æš‚æ— ä¼šè¯</div>
                    </div>
                </div>
                <div class="card">
                    <h3>ä¼šè¯å†å²</h3>
                    <div id="session-history">
                        <div class="empty-state">é€‰æ‹©ä¸€ä¸ªä¼šè¯æŸ¥çœ‹å†å²</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­£åˆ™è§„åˆ™ -->
        <div class="panel" id="regex">
            <h2>æ­£åˆ™è§„åˆ™</h2>
            <div class="grid">
                <div class="card">
                    <h3>è§„åˆ™åˆ—è¡¨</h3>
                    <div id="regex-list">
                        <div class="empty-state">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <div class="card">
                    <h3>æ·»åŠ è§„åˆ™</h3>
                    <div class="form-group">
                        <label>è§„åˆ™åç§°</label>
                        <input type="text" id="regex-name" placeholder="ä¾‹å¦‚: ç§»é™¤æ€è€ƒæ ‡ç­¾">
                    </div>
                    <div class="form-group">
                        <label>æ­£åˆ™è¡¨è¾¾å¼</label>
                        <input type="text" id="regex-pattern" placeholder="ä¾‹å¦‚: <thinking>[\s\S]*?</thinking>">
                    </div>
                    <div class="form-group">
                        <label>æ ‡å¿—</label>
                        <input type="text" id="regex-flags" placeholder="ä¾‹å¦‚: gi" value="g">
                    </div>
                    <div class="form-group">
                        <label>æ›¿æ¢ä¸º</label>
                        <input type="text" id="regex-replacement" placeholder="ç•™ç©ºè¡¨ç¤ºåˆ é™¤">
                    </div>
                    <div class="form-group">
                        <label>å¤„ç†é˜¶æ®µ</label>
                        <select id="regex-stage">
                            <option value="output">è¾“å‡º (AI å›å¤)</option>
                            <option value="input">è¾“å…¥ (ç”¨æˆ·æ¶ˆæ¯)</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button onclick="addRegexRule()">æ·»åŠ è§„åˆ™</button>
                        <button class="secondary" onclick="testRegex()">æµ‹è¯•è§„åˆ™</button>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>æµ‹è¯•æ–‡æœ¬</label>
                        <textarea id="regex-test-text" placeholder="è¾“å…¥è¦æµ‹è¯•çš„æ–‡æœ¬..."></textarea>
                    </div>
                    <div id="regex-test-result" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- é…ç½® -->
        <div class="panel" id="config">
            <h2>ç³»ç»Ÿé…ç½®</h2>
            <div class="grid">
                <div class="card">
                    <h3>OneBot è¿æ¥</h3>
                    <div class="form-group">
                        <label>WebSocket URL</label>
                        <input type="text" id="config-onebot-url" placeholder="ws://127.0.0.1:3001">
                    </div>
                    <div class="form-group">
                        <label>Access Token (å¯é€‰)</label>
                        <input type="password" id="config-onebot-token" placeholder="ç•™ç©ºè¡¨ç¤ºæ— éœ€è®¤è¯">
                    </div>
                </div>
                <div class="card">
                    <h3>AI é…ç½®</h3>
                    <div class="form-group">
                        <label>API Base URL</label>
                        <input type="text" id="config-ai-baseurl" placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="config-ai-apikey" placeholder="sk-...">
                    </div>
                    <div class="form-group">
                        <label>æ¨¡å‹</label>
                        <input type="text" id="config-ai-model" placeholder="gpt-4">
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§ Tokens</label>
                        <input type="number" id="config-ai-maxtokens" placeholder="4096">
                    </div>
                    <div class="form-group">
                        <label>Temperature</label>
                        <input type="number" id="config-ai-temperature" step="0.1" min="0" max="2" placeholder="0.7">
                    </div>
                </div>
                <div class="card">
                    <h3>èŠå¤©è®¾ç½®</h3>
                    <div class="form-group">
                        <label>è§¦å‘å‰ç¼€ (ç•™ç©ºè¡¨ç¤ºæ‰€æœ‰æ¶ˆæ¯)</label>
                        <input type="text" id="config-chat-trigger" placeholder="ä¾‹å¦‚: /chat">
                    </div>
                    <div class="form-group">
                        <label>å†å²æ¶ˆæ¯æ•°é‡</label>
                        <input type="number" id="config-chat-history" placeholder="20">
                    </div>
                    <div class="form-group">
                        <label>å…è®¸çš„ç¾¤å· (é€—å·åˆ†éš”ï¼Œç•™ç©ºè¡¨ç¤ºå…¨éƒ¨)</label>
                        <input type="text" id="config-chat-groups" placeholder="123456,789012">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="config-chat-split" checked>
                            ğŸ“ æ¶ˆæ¯åˆ†æ®µ (åŒæ¢è¡Œåˆ†å‰²æˆå¤šæ¡æ¶ˆæ¯)
                        </label>
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                            å¼€å¯åï¼ŒAI å›å¤ä¸­çš„åŒæ¢è¡Œä¼šè¢«åˆ†å‰²æˆå¤šæ¡æ¶ˆæ¯å‘é€
                        </p>
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="success" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="panel" id="logs">
            <h2>å®æ—¶æ—¥å¿—</h2>
            <div class="btn-group" style="margin-bottom: 15px;">
                <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="secondary" onclick="refreshLogs()">åˆ·æ–°</button>
            </div>
            <div class="log-container" id="log-container">
                <div class="empty-state">ç­‰å¾…æ—¥å¿—...</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let currentConfig = {};
        let selectedSession = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            loadStatus();
            loadCharacters();
            loadWorldBooks();
            loadSessions();
            loadRegexRules();
            loadConfig();
            connectLogWebSocket();
            
            // å®šæ—¶åˆ·æ–°çŠ¶æ€
            setInterval(loadStatus, 10000);
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.panel).classList.add('active');
                });
            });
        }

        // åŠ è½½çŠ¶æ€
        async function loadStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                
                const connected = data.onebot.connected;
                document.getElementById('onebot-status').classList.toggle('connected', connected);
                document.getElementById('onebot-status-2').classList.toggle('connected', connected);
                document.getElementById('current-character').textContent = data.character || 'æœªé€‰æ‹©è§’è‰²';
                document.getElementById('dash-character').textContent = data.character || '-';
                document.getElementById('dash-worldbook').textContent = data.worldbook || '-';
                document.getElementById('dash-sessions').textContent = data.sessions;
            } catch (e) {
                console.error('åŠ è½½çŠ¶æ€å¤±è´¥', e);
            }
        }

        // è§’è‰²å¡
        async function loadCharacters() {
            try {
                const res = await fetch('/api/characters');
                const characters = await res.json();
                
                const list = document.getElementById('character-list');
                if (characters.length === 0) {
                    list.innerHTML = '<div class="empty-state">æš‚æ— è§’è‰²å¡</div>';
                    return;
                }
                
                list.innerHTML = characters.map(c => `
                    <div class="list-item" onclick="selectCharacter('${c.filename}')">
                        <div>
                            <div class="name">${c.name}</div>
                            <div class="meta">${c.filename}</div>
                        </div>
                        <button class="danger" onclick="event.stopPropagation(); deleteCharacter('${c.filename}')" style="padding: 5px 10px;">åˆ é™¤</button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥', e);
            }
        }

        // å½“å‰é€‰ä¸­çš„è§’è‰²æ•°æ®
        let currentCharacterData = null;
        let currentCharacterFilename = null;

        async function selectCharacter(filename) {
            try {
                const res = await fetch('/api/characters/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('è§’è‰²å·²é€‰æ‹©');
                    loadStatus();
                    
                    currentCharacterData = data.character;
                    currentCharacterFilename = filename;
                    renderCharacterDetail(data.character, filename);
                }
            } catch (e) {
                showToast('é€‰æ‹©è§’è‰²å¤±è´¥', true);
            }
        }

        function renderCharacterDetail(char, filename) {
            const detail = document.getElementById('character-detail');
            const hasWorldBook = char.data?.character_book || char.character_book;
            const worldBookEntries = hasWorldBook ? (char.data?.character_book?.entries || char.character_book?.entries || []).length : 0;
            
            detail.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 1.2rem; font-weight: bold;">${char.name || 'æœªå‘½å'}</span>
                    <div class="btn-group">
                        ${hasWorldBook ? `<button onclick="extractWorldBook()" style="padding: 5px 10px; background: #1a1a1a; color: white;">ğŸ“š æå–ä¸–ç•Œä¹¦ (${worldBookEntries}æ¡)</button>` : ''}
                        <button onclick="saveCharacter()" style="padding: 5px 10px; background: #1a1a1a; color: white;">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>
                
                <div style="display: grid; gap: 15px; max-height: 500px; overflow-y: auto;">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="form-group">
                        <label>ğŸ“ è§’è‰²åç§°</label>
                        <input type="text" id="char-name" value="${escapeHtml(char.name || '')}" placeholder="è§’è‰²åç§°">
                    </div>
                    
                    <!-- ä¸»è¦æç¤ºè¯ (System Prompt) -->
                    <div class="form-group">
                        <label>ğŸ¯ ä¸»è¦æç¤ºè¯ (System Prompt)</label>
                        <textarea id="char-system-prompt" rows="4" placeholder="ç³»ç»Ÿæç¤ºè¯ï¼Œå®šä¹‰AIçš„è¡Œä¸ºæ–¹å¼...">${escapeHtml(char.system_prompt || char.data?.system_prompt || '')}</textarea>
                    </div>
                    
                    <!-- è§’è‰²æè¿° -->
                    <div class="form-group">
                        <label>ğŸ“– è§’è‰²æè¿° (Description)</label>
                        <textarea id="char-description" rows="4" placeholder="è§’è‰²çš„è¯¦ç»†æè¿°...">${escapeHtml(char.description || char.data?.description || '')}</textarea>
                    </div>
                    
                    <!-- äººè®¾/æ€§æ ¼ -->
                    <div class="form-group">
                        <label>ğŸ’« äººè®¾/æ€§æ ¼ (Personality)</label>
                        <textarea id="char-personality" rows="3" placeholder="è§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹...">${escapeHtml(char.personality || char.data?.personality || '')}</textarea>
                    </div>
                    
                    <!-- æƒ…æ™¯ -->
                    <div class="form-group">
                        <label>ğŸ¬ æƒ…æ™¯ (Scenario)</label>
                        <textarea id="char-scenario" rows="3" placeholder="å¯¹è¯å‘ç”Ÿçš„åœºæ™¯...">${escapeHtml(char.scenario || char.data?.scenario || '')}</textarea>
                    </div>
                    
                    <!-- ç¬¬ä¸€æ¡æ¶ˆæ¯ -->
                    <div class="form-group">
                        <label>ğŸ‘‹ ç¬¬ä¸€æ¡æ¶ˆæ¯ (First Message)</label>
                        <textarea id="char-first-mes" rows="3" placeholder="è§’è‰²çš„å¼€åœºç™½...">${escapeHtml(char.first_mes || char.data?.first_mes || '')}</textarea>
                    </div>
                    
                    <!-- å¯¹è¯ç¤ºä¾‹ -->
                    <div class="form-group">
                        <label>ğŸ’¬ å¯¹è¯ç¤ºä¾‹ (Example Dialogue)</label>
                        <textarea id="char-mes-example" rows="4" placeholder="ç¤ºä¾‹å¯¹è¯ï¼Œæ ¼å¼å¦‚: <START>\\n{{user}}: ä½ å¥½\\n{{char}}: ä½ å¥½å‘€ï¼">${escapeHtml(char.mes_example || char.data?.mes_example || '')}</textarea>
                    </div>
                    
                    <!-- åç»­å†å²æŒ‡ä»¤ -->
                    <div class="form-group">
                        <label>ğŸ“Œ åç»­å†å²æŒ‡ä»¤ (Post History Instructions)</label>
                        <textarea id="char-post-history" rows="3" placeholder="åœ¨èŠå¤©å†å²ä¹‹åæ’å…¥çš„æŒ‡ä»¤...">${escapeHtml(char.post_history_instructions || char.data?.post_history_instructions || '')}</textarea>
                    </div>
                    
                    <!-- åˆ›ä½œè€…å¤‡æ³¨ -->
                    <div class="form-group">
                        <label>ğŸ“ åˆ›ä½œè€…å¤‡æ³¨</label>
                        <textarea id="char-creator-notes" rows="2" placeholder="ç»™ä½¿ç”¨è€…çš„è¯´æ˜...">${escapeHtml(char.creator_notes || char.data?.creator_notes || '')}</textarea>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        async function saveCharacter() {
            if (!currentCharacterFilename) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', true);
                return;
            }
            
            const updatedData = {
                name: document.getElementById('char-name').value,
                system_prompt: document.getElementById('char-system-prompt').value,
                description: document.getElementById('char-description').value,
                personality: document.getElementById('char-personality').value,
                scenario: document.getElementById('char-scenario').value,
                first_mes: document.getElementById('char-first-mes').value,
                mes_example: document.getElementById('char-mes-example').value,
                post_history_instructions: document.getElementById('char-post-history').value,
                creator_notes: document.getElementById('char-creator-notes').value
            };
            
            try {
                const res = await fetch(`/api/characters/${encodeURIComponent(currentCharacterFilename)}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('è§’è‰²å·²ä¿å­˜');
                    // æ›´æ–°å½“å‰æ•°æ®
                    Object.assign(currentCharacterData, updatedData);
                    if (currentCharacterData.data) {
                        Object.assign(currentCharacterData.data, updatedData);
                    }
                    loadStatus();
                } else {
                    showToast('ä¿å­˜å¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥', true);
            }
        }

        async function extractWorldBook() {
            if (!currentCharacterData) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²', true);
                return;
            }
            
            if (!currentCharacterFilename) {
                showToast('è§’è‰²æ–‡ä»¶åæœªçŸ¥', true);
                return;
            }
            
            const worldBook = currentCharacterData.data?.character_book || currentCharacterData.character_book;
            if (!worldBook) {
                showToast('æ­¤è§’è‰²å¡æ²¡æœ‰å†…åµŒä¸–ç•Œä¹¦', true);
                return;
            }
            
            try {
                const res = await fetch('/api/worldbooks/extract-from-character', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        filename: currentCharacterFilename
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast(`ä¸–ç•Œä¹¦å·²æå–: ${data.filename}`);
                    loadWorldBooks();
                } else {
                    showToast('æå–å¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('æå–å¤±è´¥', true);
            }
        }

        async function refreshCharacters() {
            try {
                await fetch('/api/characters/refresh', { method: 'POST' });
                loadCharacters();
                showToast('è§’è‰²åˆ—è¡¨å·²åˆ·æ–°');
            } catch (e) {
                showToast('åˆ·æ–°å¤±è´¥', true);
            }
        }

        // ä¸Šä¼ è§’è‰²å¡
        async function uploadCharacter(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const res = await fetch('/api/characters/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast(`è§’è‰²å¡ "${data.filename}" ä¸Šä¼ æˆåŠŸ`);
                    loadCharacters();
                } else {
                    showToast('ä¸Šä¼ å¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('ä¸Šä¼ å¤±è´¥', true);
            }
            input.value = ''; // æ¸…ç©ºé€‰æ‹©
        }

        // åˆ é™¤è§’è‰²å¡
        async function deleteCharacter(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²å¡ "${filename}" å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`/api/characters/${encodeURIComponent(filename)}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('è§’è‰²å¡å·²åˆ é™¤');
                    loadCharacters();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', true);
            }
        }

        // ä¸–ç•Œä¹¦
        async function loadWorldBooks() {
            try {
                const res = await fetch('/api/worldbooks');
                const worldbooks = await res.json();
                
                const list = document.getElementById('worldbook-list');
                if (worldbooks.length === 0) {
                    list.innerHTML = '<div class="empty-state">æš‚æ— ä¸–ç•Œä¹¦</div>';
                    return;
                }
                
                // API è¿”å›çš„æ˜¯æ–‡ä»¶åæ•°ç»„ï¼ˆå­—ç¬¦ä¸²ï¼‰
                list.innerHTML = worldbooks.map(filename => `
                    <div class="list-item" onclick="selectWorldBook('${filename}')">
                        <div>
                            <div class="name">${filename.replace('.json', '')}</div>
                            <div class="meta">${filename}</div>
                        </div>
                        <button class="danger" onclick="event.stopPropagation(); deleteWorldBook('${filename}')" style="padding: 5px 10px;">åˆ é™¤</button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½ä¸–ç•Œä¹¦åˆ—è¡¨å¤±è´¥', e);
            }
        }

        // å½“å‰é€‰ä¸­çš„ä¸–ç•Œä¹¦æ•°æ®
        let currentWorldBookData = null;
        let currentWorldBookFilename = null;
        let currentEditingEntryIndex = null;

        async function selectWorldBook(filename) {
            try {
                const res = await fetch('/api/worldbooks/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('ä¸–ç•Œä¹¦å·²åŠ è½½');
                    loadStatus();
                    
                    // åŠ è½½ä¸–ç•Œä¹¦å†…å®¹ç”¨äºç¼–è¾‘
                    currentWorldBookFilename = filename;
                    await loadWorldBookContent(filename);
                }
            } catch (e) {
                showToast('åŠ è½½ä¸–ç•Œä¹¦å¤±è´¥', true);
            }
        }

        async function loadWorldBookContent(filename) {
            try {
                const res = await fetch(`/api/worldbooks/${encodeURIComponent(filename)}/content`);
                const data = await res.json();
                
                if (data.success) {
                    currentWorldBookData = data.worldbook;
                    renderWorldBookEditor();
                } else {
                    showToast('åŠ è½½ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('åŠ è½½ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥', true);
            }
        }

        function renderWorldBookEditor() {
            const editor = document.getElementById('worldbook-editor');
            if (!currentWorldBookData) {
                editor.innerHTML = '<div class="empty-state">é€‰æ‹©ä¸€ä¸ªä¸–ç•Œä¹¦æŸ¥çœ‹å’Œç¼–è¾‘æ¡ç›®</div>';
                return;
            }

            // è·å–æ¡ç›®åˆ—è¡¨ï¼ˆæ”¯æŒæ•°ç»„æ ¼å¼å’Œå¯¹è±¡æ ¼å¼ï¼‰
            let entries = [];
            if (Array.isArray(currentWorldBookData.entries)) {
                entries = currentWorldBookData.entries;
            } else if (currentWorldBookData.entries && typeof currentWorldBookData.entries === 'object') {
                entries = Object.values(currentWorldBookData.entries);
            }

            editor.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 1rem; font-weight: bold;">${currentWorldBookFilename.replace('.json', '')} (${entries.length} æ¡ç›®)</span>
                    <div class="btn-group">
                        <button onclick="addNewEntry()" style="padding: 5px 10px; background: #1a1a1a; color: white;">â• æ–°å¢æ¡ç›®</button>
                        <button onclick="saveWorldBook()" style="padding: 5px 10px; background: #1a1a1a; color: white;">ğŸ’¾ ä¿å­˜ä¸–ç•Œä¹¦</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <!-- æ¡ç›®åˆ—è¡¨ -->
                    <div style="max-height: 450px; overflow-y: auto;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">æ¡ç›®åˆ—è¡¨</div>
                        ${entries.length === 0 ? '<div class="empty-state" style="padding: 20px;">æš‚æ— æ¡ç›®</div>' : 
                            entries.map((entry, index) => `
                                <div class="list-item ${currentEditingEntryIndex === index ? 'selected' : ''}" 
                                     onclick="editEntry(${index})" 
                                     style="margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div class="name">${escapeHtml(entry.comment || entry.name || 'æœªå‘½åæ¡ç›®')}</div>
                                        <div class="meta">
                                            ${entry.constant ? 'ğŸ”’ å¸¸é©»' : 'ğŸ”‘ å…³é”®è¯è§¦å‘'}
                                            ${entry.enabled === false ? ' | âŒ å·²ç¦ç”¨' : ''}
                                        </div>
                                        <div class="meta" style="font-size: 0.8rem;">
                                            å…³é”®è¯: ${(entry.keys || entry.key || []).slice(0, 3).join(', ')}${(entry.keys || entry.key || []).length > 3 ? '...' : ''}
                                        </div>
                                    </div>
                                    <button class="danger" onclick="event.stopPropagation(); deleteEntry(${index})" style="padding: 3px 8px; font-size: 0.8rem;">åˆ é™¤</button>
                                </div>
                            `).join('')
                        }
                    </div>
                    
                    <!-- æ¡ç›®ç¼–è¾‘è¡¨å• -->
                    <div id="entry-edit-form">
                        <div class="empty-state" style="padding: 20px;">ç‚¹å‡»å·¦ä¾§æ¡ç›®è¿›è¡Œç¼–è¾‘ï¼Œæˆ–ç‚¹å‡»"æ–°å¢æ¡ç›®"</div>
                    </div>
                </div>
            `;
        }

        function editEntry(index) {
            currentEditingEntryIndex = index;
            
            // è·å–æ¡ç›®
            let entries = [];
            if (Array.isArray(currentWorldBookData.entries)) {
                entries = currentWorldBookData.entries;
            } else if (currentWorldBookData.entries && typeof currentWorldBookData.entries === 'object') {
                entries = Object.values(currentWorldBookData.entries);
            }
            
            const entry = entries[index];
            if (!entry) return;

            // å…ˆåˆ·æ–°åˆ—è¡¨ä»¥æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€ï¼Œå†æ¸²æŸ“ç¼–è¾‘è¡¨å•
            renderWorldBookEditor();
            renderEntryForm(entry, index);
        }

        function renderEntryForm(entry, index) {
            const form = document.getElementById('entry-edit-form');
            const keys = entry.keys || entry.key || [];
            const keysStr = Array.isArray(keys) ? keys.join(', ') : keys;
            
            form.innerHTML = `
                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">
                    ${index !== null ? `ç¼–è¾‘æ¡ç›® #${index + 1}` : 'æ–°å¢æ¡ç›®'}
                </div>
                
                <div class="form-group">
                    <label>ğŸ“ æ¡ç›®åç§°/å¤‡æ³¨</label>
                    <input type="text" id="entry-comment" value="${escapeHtml(entry.comment || entry.name || '')}" placeholder="æ¡ç›®åç§°">
                </div>
                
                <div class="form-group">
                    <label>ğŸ”‘ å…³é”®è¯ (é€—å·åˆ†éš”)</label>
                    <input type="text" id="entry-keys" value="${escapeHtml(keysStr)}" placeholder="å…³é”®è¯1, å…³é”®è¯2, ...">
                </div>
                
                <div class="form-group">
                    <label>ğŸ“– å†…å®¹</label>
                    <textarea id="entry-content" rows="6" placeholder="æ¡ç›®å†…å®¹...">${escapeHtml(entry.content || '')}</textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="entry-constant" ${entry.constant ? 'checked' : ''}>
                            ğŸ”’ å¸¸é©» (å§‹ç»ˆæ³¨å…¥)
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="entry-enabled" ${entry.enabled !== false ? 'checked' : ''}>
                            âœ… å¯ç”¨
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“Š ä¼˜å…ˆçº§ (æ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆ)</label>
                    <input type="number" id="entry-order" value="${entry.order || entry.insertion_order || 0}" placeholder="0">
                </div>
                
                <div class="btn-group" style="margin-top: 15px;">
                    <button onclick="saveEntry(${index})" style="background: #1a1a1a; color: white;">ğŸ’¾ ä¿å­˜æ¡ç›®</button>
                    <button class="secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
                </div>
            `;
        }

        function addNewEntry() {
            currentEditingEntryIndex = null;
            const newEntry = {
                comment: '',
                keys: [],
                content: '',
                constant: false,
                enabled: true,
                order: 0
            };
            renderEntryForm(newEntry, null);
        }

        function saveEntry(index) {
            const comment = document.getElementById('entry-comment').value;
            const keysStr = document.getElementById('entry-keys').value;
            const content = document.getElementById('entry-content').value;
            const constant = document.getElementById('entry-constant').checked;
            const enabled = document.getElementById('entry-enabled').checked;
            const order = parseInt(document.getElementById('entry-order').value) || 0;

            const keys = keysStr.split(',').map(k => k.trim()).filter(k => k);

            const entryData = {
                comment,
                keys,
                key: keys, // å…¼å®¹ä¸¤ç§æ ¼å¼
                content,
                constant,
                enabled,
                order,
                insertion_order: order
            };

            // ç¡®ä¿ entries æ˜¯æ•°ç»„
            if (!Array.isArray(currentWorldBookData.entries)) {
                if (currentWorldBookData.entries && typeof currentWorldBookData.entries === 'object') {
                    currentWorldBookData.entries = Object.values(currentWorldBookData.entries);
                } else {
                    currentWorldBookData.entries = [];
                }
            }

            if (index !== null && index >= 0) {
                // æ›´æ–°ç°æœ‰æ¡ç›®
                currentWorldBookData.entries[index] = entryData;
                showToast('æ¡ç›®å·²æ›´æ–°');
            } else {
                // æ·»åŠ æ–°æ¡ç›®
                currentWorldBookData.entries.push(entryData);
                currentEditingEntryIndex = currentWorldBookData.entries.length - 1;
                showToast('æ¡ç›®å·²æ·»åŠ ');
            }

            renderWorldBookEditor();
            // é‡æ–°æ¸²æŸ“ç¼–è¾‘è¡¨å•
            if (currentEditingEntryIndex !== null) {
                renderEntryForm(currentWorldBookData.entries[currentEditingEntryIndex], currentEditingEntryIndex);
            }
        }

        function deleteEntry(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¡ç›®å—ï¼Ÿ')) return;

            // ç¡®ä¿ entries æ˜¯æ•°ç»„
            if (!Array.isArray(currentWorldBookData.entries)) {
                if (currentWorldBookData.entries && typeof currentWorldBookData.entries === 'object') {
                    currentWorldBookData.entries = Object.values(currentWorldBookData.entries);
                } else {
                    currentWorldBookData.entries = [];
                }
            }

            currentWorldBookData.entries.splice(index, 1);
            
            if (currentEditingEntryIndex === index) {
                currentEditingEntryIndex = null;
            } else if (currentEditingEntryIndex > index) {
                currentEditingEntryIndex--;
            }

            showToast('æ¡ç›®å·²åˆ é™¤');
            renderWorldBookEditor();
        }

        function cancelEdit() {
            currentEditingEntryIndex = null;
            const form = document.getElementById('entry-edit-form');
            form.innerHTML = '<div class="empty-state" style="padding: 20px;">ç‚¹å‡»å·¦ä¾§æ¡ç›®è¿›è¡Œç¼–è¾‘ï¼Œæˆ–ç‚¹å‡»"æ–°å¢æ¡ç›®"</div>';
            renderWorldBookEditor();
        }

        async function saveWorldBook() {
            if (!currentWorldBookFilename || !currentWorldBookData) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä¸–ç•Œä¹¦', true);
                return;
            }

            try {
                const res = await fetch(`/api/worldbooks/${encodeURIComponent(currentWorldBookFilename)}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ worldbook: currentWorldBookData })
                });
                const data = await res.json();

                if (data.success) {
                    showToast('ä¸–ç•Œä¹¦å·²ä¿å­˜');
                } else {
                    showToast('ä¿å­˜å¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥', true);
            }
        }

        async function refreshWorldBooks() {
            try {
                await fetch('/api/worldbooks/refresh', { method: 'POST' });
                loadWorldBooks();
                showToast('ä¸–ç•Œä¹¦åˆ—è¡¨å·²åˆ·æ–°');
            } catch (e) {
                showToast('åˆ·æ–°å¤±è´¥', true);
            }
        }

        // ä¸Šä¼ ä¸–ç•Œä¹¦
        async function uploadWorldBook(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const res = await fetch('/api/worldbooks/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast(`ä¸–ç•Œä¹¦ "${data.filename}" ä¸Šä¼ æˆåŠŸ`);
                    loadWorldBooks();
                } else {
                    showToast('ä¸Šä¼ å¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('ä¸Šä¼ å¤±è´¥', true);
            }
            input.value = ''; // æ¸…ç©ºé€‰æ‹©
        }

        // åˆ é™¤ä¸–ç•Œä¹¦
        async function deleteWorldBook(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¸–ç•Œä¹¦ "${filename}" å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`/api/worldbooks/${encodeURIComponent(filename)}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (data.success) {
                    showToast('ä¸–ç•Œä¹¦å·²åˆ é™¤');
                    loadWorldBooks();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', true);
            }
        }

        async function testWorldBook() {
            const text = document.getElementById('worldbook-test-text').value;
            if (!text) return;
            
            try {
                const res = await fetch('/api/worldbooks/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await res.json();
                
                const result = document.getElementById('worldbook-test-result');
                if (data.entries && data.entries.length > 0) {
                    result.innerHTML = `
                        <div style="background: var(--bg-primary); padding: 10px; border-radius: 6px;">
                            <strong>åŒ¹é…åˆ° ${data.entries.length} ä¸ªæ¡ç›®:</strong>
                            ${data.entries.map(e => `<div style="margin-top: 8px; padding: 8px; background: var(--bg-card); border-radius: 4px;">
                                <div><strong>${e.comment || 'æœªå‘½å'}</strong></div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">å…³é”®è¯: ${e.keys?.join(', ') || '-'}</div>
                            </div>`).join('')}
                        </div>
                    `;
                } else {
                    result.innerHTML = '<div style="color: var(--text-secondary);">æœªåŒ¹é…åˆ°ä»»ä½•æ¡ç›®</div>';
                }
            } catch (e) {
                showToast('æµ‹è¯•å¤±è´¥', true);
            }
        }

        // ä¼šè¯
        async function loadSessions() {
            try {
                const res = await fetch('/api/sessions');
                const sessions = await res.json();
                
                const list = document.getElementById('session-list');
                if (sessions.length === 0) {
                    list.innerHTML = '<div class="empty-state">æš‚æ— ä¼šè¯</div>';
                    return;
                }
                
                list.innerHTML = sessions.map(s => `
                    <div class="session-item">
                        <div class="session-info" onclick="viewSession('${s.id}')">
                            <div class="session-id">${s.id}</div>
                            <div class="session-meta">${s.messageCount} æ¡æ¶ˆæ¯</div>
                        </div>
                        <button class="danger" onclick="clearSession('${s.id}')">æ¸…é™¤</button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥', e);
            }
        }

        async function viewSession(sessionId) {
            selectedSession = sessionId;
            try {
                const res = await fetch(`/api/sessions/${sessionId}/history`);
                const history = await res.json();
                
                const container = document.getElementById('session-history');
                if (history.length === 0) {
                    container.innerHTML = '<div class="empty-state">æš‚æ— æ¶ˆæ¯</div>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="message-list">
                        ${history.map(m => `
                            <div class="message ${m.role}">
                                <div class="message-role">${m.role === 'user' ? 'ç”¨æˆ·' : 'AI'}</div>
                                <div class="message-content">${m.content}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                console.error('åŠ è½½ä¼šè¯å†å²å¤±è´¥', e);
            }
        }

        async function clearSession(sessionId) {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ­¤ä¼šè¯çš„å†å²è®°å½•å—ï¼Ÿ')) return;
            
            try {
                await fetch(`/api/sessions/${sessionId}/history`, { method: 'DELETE' });
                loadSessions();
                if (selectedSession === sessionId) {
                    document.getElementById('session-history').innerHTML = '<div class="empty-state">ä¼šè¯å·²æ¸…é™¤</div>';
                }
                showToast('ä¼šè¯å·²æ¸…é™¤');
            } catch (e) {
                showToast('æ¸…é™¤å¤±è´¥', true);
            }
        }

        // æ­£åˆ™è§„åˆ™
        async function loadRegexRules() {
            try {
                const res = await fetch('/api/regex');
                const rules = await res.json();
                
                const list = document.getElementById('regex-list');
                if (rules.length === 0) {
                    list.innerHTML = '<div class="empty-state">æš‚æ— è§„åˆ™</div>';
                    return;
                }
                
                list.innerHTML = rules.map((r, i) => `
                    <div class="regex-rule">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${r.name || 'æœªå‘½åè§„åˆ™'}</strong>
                            <button class="danger" onclick="deleteRegexRule(${i})" style="padding: 5px 10px;">åˆ é™¤</button>
                        </div>
                        <div class="pattern">${r.pattern}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            æ›¿æ¢ä¸º: ${r.replacement || '(åˆ é™¤)'} | é˜¶æ®µ: ${r.stage || 'output'}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½æ­£åˆ™è§„åˆ™å¤±è´¥', e);
            }
        }

        async function addRegexRule() {
            const rule = {
                name: document.getElementById('regex-name').value,
                pattern: document.getElementById('regex-pattern').value,
                flags: document.getElementById('regex-flags').value,
                replacement: document.getElementById('regex-replacement').value,
                stage: document.getElementById('regex-stage').value
            };
            
            if (!rule.pattern) {
                showToast('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼', true);
                return;
            }
            
            try {
                await fetch('/api/regex', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rule)
                });
                loadRegexRules();
                showToast('è§„åˆ™å·²æ·»åŠ ');
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('regex-name').value = '';
                document.getElementById('regex-pattern').value = '';
                document.getElementById('regex-replacement').value = '';
            } catch (e) {
                showToast('æ·»åŠ å¤±è´¥', true);
            }
        }

        async function deleteRegexRule(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è§„åˆ™å—ï¼Ÿ')) return;
            
            try {
                await fetch(`/api/regex/${index}`, { method: 'DELETE' });
                loadRegexRules();
                showToast('è§„åˆ™å·²åˆ é™¤');
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', true);
            }
        }

        async function testRegex() {
            const pattern = document.getElementById('regex-pattern').value;
            const flags = document.getElementById('regex-flags').value;
            const replacement = document.getElementById('regex-replacement').value;
            const testText = document.getElementById('regex-test-text').value;
            
            if (!pattern || !testText) {
                showToast('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼å’Œæµ‹è¯•æ–‡æœ¬', true);
                return;
            }
            
            try {
                const res = await fetch('/api/regex/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pattern, flags, replacement, testText })
                });
                const data = await res.json();
                
                const result = document.getElementById('regex-test-result');
                if (data.success) {
                    result.innerHTML = `
                        <div style="background: var(--bg-primary); padding: 10px; border-radius: 6px;">
                            <p><strong>åŒ¹é…æ•°:</strong> ${data.matches.length}</p>
                            <p><strong>ç»“æœ:</strong></p>
                            <div style="background: var(--bg-card); padding: 8px; border-radius: 4px; margin-top: 5px; white-space: pre-wrap;">${data.result}</div>
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div style="color: var(--error);">é”™è¯¯: ${data.error}</div>`;
                }
            } catch (e) {
                showToast('æµ‹è¯•å¤±è´¥', true);
            }
        }

        // é…ç½®
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                currentConfig = await res.json();
                
                document.getElementById('config-onebot-url').value = currentConfig.onebot?.url || '';
                document.getElementById('config-onebot-token').value = currentConfig.onebot?.accessToken || '';
                document.getElementById('config-ai-baseurl').value = currentConfig.ai?.baseUrl || '';
                document.getElementById('config-ai-model').value = currentConfig.ai?.model || '';
                document.getElementById('config-ai-maxtokens').value = currentConfig.ai?.maxTokens || '';
                document.getElementById('config-ai-temperature').value = currentConfig.ai?.temperature || '';
                document.getElementById('config-chat-trigger').value = currentConfig.chat?.triggerPrefix || '';
                document.getElementById('config-chat-history').value = currentConfig.chat?.historyLimit || '';
                document.getElementById('config-chat-groups').value = (currentConfig.chat?.allowedGroups || []).join(',');
                document.getElementById('config-chat-split').checked = currentConfig.chat?.splitMessage !== false;
            } catch (e) {
                console.error('åŠ è½½é…ç½®å¤±è´¥', e);
            }
        }

        async function saveConfig() {
            const newConfig = {
                onebot: {
                    url: document.getElementById('config-onebot-url').value,
                    accessToken: document.getElementById('config-onebot-token').value
                },
                ai: {
                    baseUrl: document.getElementById('config-ai-baseurl').value,
                    apiKey: document.getElementById('config-ai-apikey').value || currentConfig.ai?.apiKey,
                    model: document.getElementById('config-ai-model').value,
                    maxTokens: parseInt(document.getElementById('config-ai-maxtokens').value) || 4096,
                    temperature: parseFloat(document.getElementById('config-ai-temperature').value) || 0.7
                },
                chat: {
                    triggerPrefix: document.getElementById('config-chat-trigger').value,
                    historyLimit: parseInt(document.getElementById('config-chat-history').value) || 20,
                    allowedGroups: document.getElementById('config-chat-groups').value.split(',').filter(g => g.trim()),
                    splitMessage: document.getElementById('config-chat-split').checked,
                    defaultCharacter: currentConfig.chat?.defaultCharacter || ''
                }
            };
            
            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newConfig)
                });
                showToast('é…ç½®å·²ä¿å­˜');
                loadConfig();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥', true);
            }
        }

        // OneBot é‡è¿
        async function reconnectOneBot() {
            try {
                await fetch('/api/status/onebot/reconnect', { method: 'POST' });
                showToast('æ­£åœ¨é‡æ–°è¿æ¥...');
                setTimeout(loadStatus, 2000);
            } catch (e) {
                showToast('é‡è¿å¤±è´¥', true);
            }
        }

        // AI æµ‹è¯•
        async function testAI() {
            const message = document.getElementById('test-message').value;
            if (!message) {
                showToast('è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯', true);
                return;
            }
            
            const result = document.getElementById('test-result');
            result.style.display = 'block';
            result.textContent = 'æ­£åœ¨è¯·æ±‚...';
            
            try {
                const res = await fetch('/api/test/ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await res.json();
                
                if (data.success) {
                    result.textContent = data.response;
                } else {
                    result.textContent = 'é”™è¯¯: ' + data.error;
                }
            } catch (e) {
                result.textContent = 'è¯·æ±‚å¤±è´¥';
            }
        }

        // æ—¥å¿—
        let logWs = null;
        
        function connectLogWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            logWs = new WebSocket(`${protocol}//${location.host}/ws/logs`);
            
            logWs.onmessage = (event) => {
                const log = JSON.parse(event.data);
                addLogEntry(log);
            };
            
            logWs.onclose = () => {
                setTimeout(connectLogWebSocket, 3000);
            };
        }

        function addLogEntry(log) {
            const container = document.getElementById('log-container');
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${log.level}`;
            entry.innerHTML = `<span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>${log.message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            while (container.children.length > 200) {
                container.removeChild(container.firstChild);
            }
        }

        async function refreshLogs() {
            try {
                const res = await fetch('/api/logs');
                const logs = await res.json();
                
                const container = document.getElementById('log-container');
                container.innerHTML = '';
                logs.forEach(log => addLogEntry(log));
            } catch (e) {
                console.error('åˆ·æ–°æ—¥å¿—å¤±è´¥', e);
            }
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '<div class="empty-state">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // Toast æç¤º
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
